import"./modulepreload-polyfill-B5Qt9EMX.js";import{c as ue}from"./index-B-pfPx8Q.js";import{W as he,A as fe,S as me,C,F as ge,P as we,H as Se,D as ye,M as y,a as V,b as j,c as be,R as X,d as xe,G as z,e as Me,f as I,g as P,h as _,B as A}from"./three.module-tYR32Xpn.js";const Y="flappy-bird/prng-seed";function T(e){return e||(typeof window<"u"&&typeof window.localStorage<"u"?window.localStorage:null)}class ve{constructor(t=Date.now(),s=Y){this.storageKey=s,this.initialSeed=0,this.state=0,this.seed(t)}seed(t){const s=t>>>0;return this.initialSeed=s,this.state=s,this.initialSeed}reset(){this.state=this.initialSeed}next(){this.state=this.state+1831565813>>>0;let t=this.state;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}nextInt(t,s){if(s<t)throw new Error("max must be greater than or equal to min");const n=s-t+1;return Math.floor(this.next()*n)+t}getSeed(){return this.initialSeed}serializeSeed(){return this.initialSeed.toString(10)}saveSeed(t){const s=T(t);s&&s.setItem(this.storageKey,this.serializeSeed())}loadSeed(t){const s=T(t);if(!s)return!1;const n=s.getItem(this.storageKey);if(n===null)return!1;const a=Number.parseInt(n,10);return Number.isNaN(a)?!1:(this.seed(a),!0)}}function De(e={}){const{seed:t=Date.now(),storageKey:s=Y,storage:n=void 0,autoLoad:a=!0,autoSave:r=!0}=e,o=new ve(t,s),p=T(n);return!(a?o.loadSeed(p):!1)&&r&&p&&o.saveSeed(p),o}const m={playfieldWidth:420,playfieldHeight:640,gravity:.55,gapSize:150,pipeIntervalMs:1600,initialPipeSpeed:2.6,maxPipeSpeed:6,speedRampInterval:8,speedRampAmount:.25,speedDecayOnRestart:.35};function Ee(e,t=De()){e.width=m.playfieldWidth,e.height=m.playfieldHeight;let s=0;if(typeof window<"u"&&(window!=null&&window.localStorage)){const n=window.localStorage.getItem("flappy-best");s=Number.parseInt(n??"0",10)||0}return{canvas:e,playfieldWidth:m.playfieldWidth,playfieldHeight:m.playfieldHeight,bird:null,pipes:[],score:0,bestScore:s,gameOver:!1,awaitingStart:!0,isRunning:!1,frameCount:0,pipeSpeed:m.initialPipeSpeed,animationFrameId:null,prng:t,lastTimestamp:null,spawnTimer:0,ui:null,roundDurationMs:0,sessionStats:{attempts:0,totalScore:0,totalDurationMs:0,lastScore:0,lastDurationMs:0,bestScore:0}}}function Ie(e){e.pipes=[],e.score=0,e.gameOver=!1,e.awaitingStart=!0,e.isRunning=!1,e.frameCount=0,e.pipeSpeed=Math.max(m.initialPipeSpeed,e.pipeSpeed-m.speedDecayOnRestart),e.animationFrameId=null,e.spawnTimer=0,e.lastTimestamp=null,e.roundDurationMs=0,e.prng&&typeof e.prng.reset=="function"&&e.prng.reset()}function J(e){if(!(typeof window>"u"||!(window!=null&&window.localStorage)))try{window.localStorage.setItem("flappy-best",String(e))}catch(t){console.warn("Unable to persist best score",t)}}const Pe=Object.freeze({width:34,height:24,flapStrength:9,maxFallSpeed:13});class Re{constructor(t,s,n={}){const a={...Pe,...n};this.x=t,this.y=s,this.width=a.width,this.height=a.height,this.velocity=0,this.flapStrength=a.flapStrength,this.maxFallSpeed=a.maxFallSpeed,this.rotation=0}jump(){this.velocity=-this.flapStrength}update(t,s=1){const n=t*s;this.velocity=Math.min(this.velocity+n,this.maxFallSpeed),this.y+=this.velocity*s;const a=Math.max(-.65,Math.min(.75,this.velocity/9));this.rotation+=(a-this.rotation)*.2}getBounds(){return{left:this.x,right:this.x+this.width,top:this.y,bottom:this.y+this.height}}isOutOfBounds(t){return this.y<0||this.y+this.height>t}}function Ae(e,t,s){if(s<t)throw new Error("max must be greater than or equal to min");const n=s-t+1;if(e&&typeof e.nextInt=="function")return e.nextInt(t,s);const a=typeof e=="function"?e():e&&typeof e.next=="function"?e.next():Math.random();return Math.floor(a*n)+t}class Le{constructor(t,s,n,a=Math.random){this.x=t,this.width=60,this.gapSize=n,this.playfieldHeight=s,this.passed=!1;const r=60,o=Math.max(r,s-n-r);this.topHeight=Ae(a,r,o)}update(t,s,n,a,r){this.x-=t*s;const o=n.getBounds(),p=o.left<this.x+this.width&&o.right>this.x,u=o.top<this.topHeight,g=o.bottom>this.topHeight+this.gapSize;p&&(u||g)&&a(),!this.passed&&o.left>this.x+this.width&&(this.passed=!0,r())}draw(){}isOffScreen(){return this.x+this.width<-200}}function K(e,t,s,n){return{x:e-s/2,y:n/2-t}}function Q(e,t){const n=document.createElement("canvas");n.width=1,n.height=128;const a=n.getContext("2d"),r=a.createLinearGradient(0,0,0,128);r.addColorStop(0,e),r.addColorStop(1,t),a.fillStyle=r,a.fillRect(0,0,1,128);const o=new be(n);return o.wrapS=X,o.wrapT=xe,o.repeat.set(1,1),o}function Fe(){const e=new z,t=new I({color:16766556,emissive:10048802,roughness:.35,metalness:.1}),s=new I({color:16774064,roughness:.6}),n=new I({color:16753470,emissive:3346688,roughness:.45}),a=new y(new P(12,32,32),t);a.castShadow=!0,e.add(a);const r=new y(new P(10,32,32,0,Math.PI*2,0,Math.PI/1.8),s);r.position.set(0,-1,6),e.add(r);const o=new y(new _(5,12,16),n);o.rotation.x=Math.PI/2,o.position.set(12,-2,0),e.add(o);const p=new I({color:16777215}),u=new I({color:2236962}),g=new y(new P(3.5,16,16),p);g.position.set(6,3,8),e.add(g);const c=new y(new P(1.6,12,12),u);c.position.set(8.5,3,9.5),e.add(c);const h=new A(16,6,10),S=new y(h,n);S.position.set(-2,0,-8),S.rotation.y=Math.PI/9,S.castShadow=!0;const x=S.clone();x.position.z=8,x.rotation.y=-Math.PI/9,e.add(S,x);const v=new y(new _(5,10,16),n);return v.rotation.x=-Math.PI/2.4,v.position.set(-10,-3,0),e.add(v),e.userData.wings={left:S,right:x},e.userData.pulse=0,e}function Ce(){return new I({color:6142819,emissive:2051119,roughness:.5})}function He(){const e=Ce(),t=new y(new A(60,200,60),e),s=new y(new A(60,200,60),e);t.castShadow=s.castShadow=!0;const n=new I({color:9232754,emissive:2247704,roughness:.4}),a=new y(new A(70,20,70),n),r=a.clone(),o=new z;return o.add(t,s,a,r),o.userData={top:t,bottom:s,rimTop:a,rimBottom:r},o}function Te(e,t,s){const{top:n,bottom:a,rimTop:r,rimBottom:o}=e.userData,p=s,u=t.topHeight,g=p-(t.topHeight+t.gapSize);n.scale.y=u/200,a.scale.y=g/200,n.position.set(0,p/2-u/2,0),a.position.set(0,-p/2+g/2,0);const c=10;r.position.set(0,p/2-u-c,0),o.position.set(0,-p/2+g+c,0)}function Ge(){const e=new P(20,16,16),t=new j({color:16777215,transparent:!0,opacity:.9});return new y(e,t)}function Oe(){const e=new z;for(let t=0;t<6;t+=1){const s=Ge();s.scale.setScalar(.6+Math.random()*.8),s.position.set(Math.random()*800-400,Math.random()*200+120,-80),e.add(s)}return e}function ze(){const e=new V(1200,400,1,1),t=Q("#5fb45d","#3f7a3e");t.wrapS=X,t.repeat.set(6,1);const s=new Me({map:t});s.map.offset.x=0;const n=new y(e,s);return n.rotation.x=-Math.PI/2,n.position.set(0,-160,0),n.receiveShadow=!0,n}function Be(e,t={}){const s=new he({canvas:e,antialias:!0,alpha:!0});s.setPixelRatio(Math.min(window.devicePixelRatio||1,2)),s.shadowMap.enabled=!1,s.toneMapping=fe,s.toneMappingExposure=1.05;const n=new me;n.background=new C(10147839),n.fog=new ge(10147839,300,900);const a=new we(55,1,1,2e3);a.position.set(0,0,620);const r=new Se(14675967,4886354,1.1);n.add(r);const o=new ye(16777215,.8);o.position.set(400,500,500),o.castShadow=!1,n.add(o);const p=Q("#bce9ff","#88c8ff"),u=new y(new V(1600,1400,1,1),new j({map:p,depthWrite:!1}));u.material.map.needsUpdate=!0,u.position.set(0,100,-400),n.add(u);const g=Oe();n.add(g);const c=ze();c.material.map.needsUpdate=!0,n.add(c);const h=Fe();n.add(h);const S=new Map;let x=0;const v=()=>{const d=e.parentElement,f=(d==null?void 0:d.clientWidth)||e.clientWidth||1,l=(d==null?void 0:d.clientHeight)||e.clientHeight||1;s.setPixelRatio(Math.min(window.devicePixelRatio||1,2)),s.setSize(f,l,!1),a.aspect=f/l,a.updateProjectionMatrix()};v(),window.addEventListener("resize",v);function te(d){const f=new Set;for(const l of d.pipes){let w=S.get(l);w||(w=He(),S.set(l,w),n.add(w)),f.add(l);const E=K(l.x+l.width/2,d.playfieldHeight/2,d.playfieldWidth,d.playfieldHeight);w.position.set(E.x,E.y,0),Te(w,l,d.playfieldHeight)}for(const[l,w]of S.entries())f.has(l)||(n.remove(w),S.delete(l))}let N=0;function se(d,f){if(!d.bird)return;const{bird:l,playfieldWidth:w,playfieldHeight:E}=d,le=l.x+l.width/2,de=l.y+l.height/2,k=K(le,de,w,E);h.position.set(k.x,k.y,0);const ce=-l.rotation;if(h.rotation.z+=(ce-h.rotation.z)*.15,h.userData.pulse>0){h.userData.pulse=Math.max(0,h.userData.pulse-f/260);const pe=1+Math.sin(h.userData.pulse/.26*Math.PI)*.08;h.scale.setScalar(pe)}else h.scale.setScalar(1);N+=f;const W=Math.sin(N/120)*.5+l.rotation*.4,F=h.userData.wings;F&&(F.left.rotation.z=Math.PI/2+W,F.right.rotation.z=-Math.PI/2-W)}function ie(d,f){const l=d/1e3*(.2+f*.05);u.material.map.offset.y=(u.material.map.offset.y+l*.15)%1,c.material.map.offset.x=(c.material.map.offset.x-l)%1,g.position.x-=l*120,g.position.x<-400&&(g.position.x=0),g.rotation.z+=l*.01}function ne(d,f){if(v(),te(d),se(d,f),ie(f,d.pipeSpeed),x>0){const l=Math.max(0,1-x/600);n.fog.color.lerp(new C(16768734),.02),x-=f,s.toneMappingExposure=1+l*.3}else s.toneMappingExposure+=(1-s.toneMappingExposure)*.1,n.fog.color.lerp(new C(10147839),.05);s.render(n,a)}function ae(){h.userData.pulse=.26}function oe(){x=600}function re(){window.removeEventListener("resize",v),s.dispose(),n.traverse(d=>{var f,l,w,E;d.isMesh&&((l=(f=d.geometry)==null?void 0:f.dispose)==null||l.call(f),(E=(w=d.material)==null?void 0:w.dispose)==null||E.call(w))}),S.clear()}return{render:ne,pulseBird:ae,markGameOver:oe,dispose:re}}const Z="HUD_GAME_OVER",Ne=[{key:"attempts",label:"Attempts",format:e=>ke(e.attempts,"play")},{key:"averageScore",label:"Average score",format:e=>R(e.averageScore)},{key:"sessionBest",label:"Session best",format:e=>R(e.sessionBest)},{key:"lastScore",label:"Last score",format:e=>R(e.lastScore)},{key:"averageDurationMs",label:"Avg survival",format:e=>$(e.averageDurationMs)},{key:"lastDurationMs",label:"Last survival",format:e=>$(e.lastDurationMs)},{key:"bestScore",label:"All-time best",format:e=>R(e.bestScore)}];function R(e){return!Number.isFinite(e)||Number.isNaN(e)?"â€”":new Intl.NumberFormat(void 0,{maximumFractionDigits:e%1===0?0:1}).format(e)}function ke(e,t){if(!Number.isFinite(e)||e<=0)return`No ${t}s yet`;const s=new Intl.NumberFormat,n=e===1?t:`${t}s`;return`${s.format(e)} ${n}`}function $(e){if(!Number.isFinite(e)||e<=0)return"â€”";const t=e/1e3;if(t<10)return`${t.toFixed(1)}s`;if(t<120)return`${Math.round(t)}s`;const s=Math.floor(t/60),n=Math.round(t%60).toString().padStart(2,"0");return`${s}:${n} min`}function We(e){return e?typeof e=="string"?document.querySelector(e):e:document.querySelector("#sessionStats")}class _e{constructor(t={}){if(this.expanded=!1,this.hasData=!1,this.expand=()=>{},this.collapse=()=>{},this.updateToggleLabel=()=>{},this.root=We(t.root??null),this.toggle=document.createElement("button"),this.panel=document.createElement("div"),this.list=document.createElement("dl"),!this.root)return;const s=t.toggleLabel??"Show session stats",n=t.expandedLabel??"Hide session stats",a=`${this.root.id||"session-stats"}-panel`;this.root.classList.add("session-stats"),this.root.setAttribute("data-state","idle"),this.root.hidden=!0,this.toggle.className="session-stats__toggle",this.toggle.type="button",this.toggle.textContent=s,this.toggle.setAttribute("aria-expanded","false"),this.toggle.setAttribute("aria-controls",a),this.toggle.disabled=!0,this.panel.className="session-stats__panel",this.panel.id=a,this.panel.hidden=!0,this.panel.setAttribute("role","group"),this.panel.setAttribute("tabindex","-1");const r=document.createElement("h2");r.className="session-stats__title",r.textContent="Session stats",this.list.className="session-stats__list",this.panel.append(r,this.list),this.root.append(this.toggle,this.panel);const o=()=>{this.toggle.textContent=this.expanded?n:s},p=()=>{var c;this.expanded=!1,this.panel.hidden=!0,this.toggle.setAttribute("aria-expanded","false"),(c=this.root)==null||c.setAttribute("data-state",this.hasData?"ready":"idle"),o()},u=(c=!0)=>{var h;this.hasData&&(this.expanded=!0,this.panel.hidden=!1,this.toggle.setAttribute("aria-expanded","true"),(h=this.root)==null||h.setAttribute("data-state","open"),o(),c&&requestAnimationFrame(()=>this.panel.focus()))},g=()=>{this.expanded?(p(),requestAnimationFrame(()=>this.toggle.focus())):u()};this.toggle.addEventListener("click",g),this.toggle.addEventListener("keydown",c=>{c.key==="ArrowDown"&&!this.expanded&&(c.preventDefault(),u())}),this.panel.addEventListener("keydown",c=>{c.key==="Escape"&&(c.preventDefault(),p(),requestAnimationFrame(()=>this.toggle.focus()))}),window.addEventListener(Z,c=>{const h=c,S=!this.hasData;this.applyStats(h.detail),S&&!this.expanded&&u(!1)}),this.expand=u,this.collapse=p,this.updateToggleLabel=o}applyStats(t){if(!(!this.root||!t)){this.hasData||(this.root.hidden=!1,this.toggle.disabled=!1,this.hasData=!0,this.root.setAttribute("data-state","ready"),this.updateToggleLabel()),this.list.textContent="";for(const s of Ne){const n=document.createElement("div");n.className="session-stats__item",n.dataset.stat=s.key;const a=document.createElement("dt");a.className="session-stats__label",a.textContent=s.label;const r=document.createElement("dd");r.className="session-stats__value",r.textContent=s.format(t),n.append(a,r),this.list.append(n)}this.root.dispatchEvent(new CustomEvent("sessionstatsupdate",{bubbles:!0,detail:t})),this.expanded&&requestAnimationFrame(()=>this.panel.focus())}}}function Ke(e){return new _e(e)}let i=null,D=null,b=null;function M(){if(!i)throw new Error("Game state has not been initialized.")}function B(){if(!D)throw new Error("Renderer has not been initialized.")}function G(e){M();const t=new Le(e,i.playfieldHeight,m.gapSize,i.prng);return i.pipes.push(t),t}function L(){if(M(),!b)return;b.setScore(i.score),b.setBest(i.bestScore);const e=m.maxPipeSpeed-m.initialPipeSpeed,t=Math.min(1,(i.pipeSpeed-m.initialPipeSpeed)/e);b.setSpeed(t)}function $e(){M();let e=!1;return i.score>i.bestScore&&(i.bestScore=i.score,J(i.bestScore),e=!0),e}function qe(){b&&b.showIntro()}function Ue(e,t){M();for(let s=i.pipes.length-1;s>=0;s-=1){const n=i.pipes[s];n.update(i.pipeSpeed,e,i.bird,t,()=>{i.score+=1,i.score>0&&i.score%m.speedRampInterval===0&&(i.pipeSpeed=Math.min(m.maxPipeSpeed,i.pipeSpeed+m.speedRampAmount)),i.score>i.bestScore&&(i.bestScore=i.score,J(i.bestScore)),L()}),n.isOffScreen()&&i.pipes.splice(s,1)}}function Ve(){M(),B(),Ie(i),i.sessionStats.attempts+=1,i.sessionStats.lastScore=0,i.sessionStats.lastDurationMs=0,i.bird=new Re(80,i.playfieldHeight/2,{width:38,height:26,flapStrength:9.5}),i.awaitingStart=!1,i.isRunning=!0,i.gameOver=!1,i.pipes.length=0,G(i.playfieldWidth+120),G(i.playfieldWidth+120+260),L(),b&&b.showRunning()}function q(){M(),i.isRunning=!1,i.gameOver=!0,i.awaitingStart=!0;const e=$e();if(L(),i.sessionStats.lastScore=i.score,i.sessionStats.lastDurationMs=i.roundDurationMs,i.sessionStats.totalScore+=i.score,i.sessionStats.totalDurationMs+=i.roundDurationMs,i.sessionStats.bestScore=Math.max(i.sessionStats.bestScore,i.score),b&&b.showGameOver(i.score,i.bestScore,{isNewRecord:e}),typeof window<"u"){const t=i.sessionStats.attempts;window.dispatchEvent(new CustomEvent(Z,{detail:{attempts:t,averageScore:t>0?i.sessionStats.totalScore/t:0,averageDurationMs:t>0?i.sessionStats.totalDurationMs/t:0,lastScore:i.sessionStats.lastScore,lastDurationMs:i.sessionStats.lastDurationMs,sessionBest:i.sessionStats.bestScore,bestScore:i.bestScore}}))}D&&D.markGameOver()}function ee(e){M(),B();const t=e??performance.now();i.lastTimestamp===null&&(i.lastTimestamp=t);const s=Math.min(t-i.lastTimestamp,1e3/15);i.lastTimestamp=t;const n=s/(1e3/60);if(i.roundDurationMs+=s,i.spawnTimer+=s,i.spawnTimer>=m.pipeIntervalMs){const a=i.spawnTimer-m.pipeIntervalMs;i.spawnTimer=a,G(i.playfieldWidth+100)}i.bird.update(m.gravity,n),Ue(n,()=>q()),i.bird.isOutOfBounds(i.playfieldHeight)&&q(),D.render(i,s),i.gameOver||(i.animationFrameId=requestAnimationFrame(ee))}function je(e,t={}){i=e,D=Be(i.canvas,t.rendererOptions),b=ue(t.hudElements??{}),L(),D.render(i,0),qe()}function O(){M(),B(),i.animationFrameId!==null&&(cancelAnimationFrame(i.animationFrameId),i.animationFrameId=null),Ve(),i.lastTimestamp=null,i.animationFrameId=requestAnimationFrame(ee)}function H(){if(M(),i.awaitingStart||i.gameOver){O();return}i.isRunning&&(i.bird.jump(),D&&D.pulseBird())}function Xe(e){const t=n=>{n.preventDefault(),H()};e.addEventListener("pointerdown",t),e.addEventListener("keydown",n=>{if(n.repeat)return;new Set(["Space","ArrowUp","KeyW","KeyX"]).has(n.code)?t(n):n.code==="KeyR"&&(n.preventDefault(),O())},{passive:!1}),window.addEventListener("keydown",n=>{if(n.repeat)return;new Set(["Space","ArrowUp","KeyW"]).has(n.code)?(n.preventDefault(),H()):n.code==="KeyR"&&(n.preventDefault(),O())},{passive:!1}),e.addEventListener("touchstart",t,{passive:!1});const s=document.getElementById("startButton");s==null||s.addEventListener("click",()=>{H()})}function U(e){if(!e.parentElement)return;const s=m.playfieldHeight/m.playfieldWidth,n=Math.min(window.innerWidth*.9,540),a=Math.max(280,n),r=a*s;e.style.width=`${a}px`,e.style.height=`${r}px`}function Ye(){const e=document.getElementById("gameCanvas");if(!e)throw new Error("Game canvas not found");e.setAttribute("role","application"),e.setAttribute("aria-label","Flappy Bird 3D playfield"),e.setAttribute("tabindex","0");const t=Ee(e);je(t,{hudElements:{score:"#scoreValue",best:"#bestValue",message:"#gameMessage",startButton:"#startButton",overlay:"#gameOverlay",speedBar:"#speedFill",speedProgress:"#speedProgress",perfectIndicator:"#perfectIndicator"}}),Ke(),Xe(e),U(e),window.addEventListener("resize",()=>U(e))}window.addEventListener("DOMContentLoaded",Ye);
